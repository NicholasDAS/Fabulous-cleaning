{% extends "base.html" %}
{% block content %}

<div class="container mt-4 mb-5">

    <!-- ================= PROFILE SUMMARY ================= -->
    <div class="card shadow-sm mb-4 p-3" style="border-radius: 14px;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="fw-bold mb-1">{{ user.fullname }}</h4>
                <p class="mb-1 text-muted">{{ user.email }}</p>
                <small class="text-muted">
                    Member since {{ user.bookings[0].created_at.strftime('%Y-%m-%d') if user.bookings else "â€”" }}
                </small>
            </div>
            <a href="/profile" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-person-circle"></i> View Profile
            </a>
        </div>
    </div>

    <h3 class="fw-bold mb-3">Upcoming Bookings</h3>

    {% set today = namespace(value=cycler).__class__.__mro__[1] %}
    {% set has_upcoming = false %}

    <div class="row g-4">
        {% for b in bookings %}
            {% if b.date >= now.strftime('%Y-%m-%d') %}
                {% set has_upcoming = true %}
                <div class="col-md-6">
                    <div class="card shadow-sm p-3" style="border-radius: 12px;">

                        <div class="d-flex justify-content-between">
                            <h5 class="fw-bold text-primary">
                                <i class="bi bi-stars"></i> {{ b.service_type }}
                            </h5>

                            <!-- STATUS BADGE -->
                            {% if b.status == "Confirmed" %}
                                <span class="badge bg-success">{{ b.status }}</span>
                            {% elif b.status == "Edited" %}
                                <span class="badge bg-warning text-dark">{{ b.status }}</span>
                            {% elif b.status == "Completed" %}
                                <span class="badge bg-secondary">{{ b.status }}</span>
                            {% elif b.status == "Cancelled" %}
                                <span class="badge bg-danger">{{ b.status }}</span>
                            {% else %}
                                <span class="badge bg-info">{{ b.status }}</span>
                            {% endif %}
                        </div>

                        <ul class="list-group list-group-flush my-3">
                            <li class="list-group-item"><strong>Date:</strong> {{ b.date }}</li>
                            <li class="list-group-item"><strong>Time:</strong> {{ b.time }}</li>
                            <li class="list-group-item"><strong>Rooms:</strong> {{ b.rooms }}</li>
                            <li class="list-group-item"><strong>Address:</strong> {{ b.address }}</li>
                        </ul>

                        <!-- ACTIONS -->
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                Created {{ b.created_at.strftime('%Y-%m-%d %H:%M') }}
                            </small>

                            {% if b.status != "Completed" %}
                            <button
                                class="btn btn-outline-primary btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#editBookingModal{{ b.id }}">
                                <i class="bi bi-pencil-square"></i> Edit
                            </button>
                            {% endif %}
                        </div>

                    </div>
                </div>
            {% endif %}
        {% endfor %}
    </div>

    {% if not has_upcoming %}
        <div class="alert alert-info mt-3">
            We are always ready to make your space sparkle!
            <a href="/booking" class="btn btn-sm btn-primary ms-2">Book a Cleaning</a>
        </div>
    {% endif %}

    <!-- ================= BOOKING HISTORY ================= -->
    <h3 class="fw-bold mt-5 mb-3">Booking History</h3>

    {% for b in bookings %}
        {% if b.date < now.strftime('%Y-%m-%d') %}
            <div class="card mb-2 shadow-sm p-3">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>{{ b.service_type }}</strong>
                        <div class="text-muted small">{{ b.date }} at {{ b.time }}</div>
                    </div>
                    <span class="badge bg-secondary">{{ b.status }}</span>
                </div>
            </div>
        {% endif %}
        <!-- ================= EDIT BOOKING MODAL ================= -->
<div class="modal fade" id="editBookingModal{{ b.id }}" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <form method="POST" action="/booking/{{ b.id }}/edit">

        <div class="modal-header">
          <h5 class="modal-title">
            Edit Booking
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Service Type</label>
            <select class="form-select" name="service_type" required>
              <option {{ 'selected' if b.service_type == 'Basic Home Cleaning' }}>Basic Home Cleaning</option>
              <option {{ 'selected' if b.service_type == 'Deep Cleaning' }}>Deep Cleaning</option>
              <option {{ 'selected' if b.service_type == 'Move-In / Move-Out Cleaning' }}>Move-In / Move-Out Cleaning</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" name="date" value="{{ b.date }}" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Time</label>
            <input type="time" class="form-control" name="time" value="{{ b.time }}" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Rooms</label>
            <input type="text" class="form-control" name="rooms" value="{{ b.rooms }}" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Address</label>
            <input type="text" class="form-control" name="address" value="{{ b.address }}" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" name="note">{{ b.note }}</textarea>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            Confirm Changes
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

    {% endfor %}

</div>

{% endblock %}
